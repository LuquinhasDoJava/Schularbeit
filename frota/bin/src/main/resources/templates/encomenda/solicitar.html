<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head th:replace="~{fragmentos/head :: head('Solicitar Encomenda')}"></head>
<body>
<header th:replace="~{fragmentos/header :: header(activePage='encomenda')}"></header>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-shipping-fast me-2"></i>
                        Solicitar Encomenda
                    </h3>
                </div>
                <div class="card-body">

                    <!-- Informa√ß√µes do Produto -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-cube me-2"></i>Informa√ß√µes do Produto
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tbody>
                                    <tr>
                                        <th width="20%">ID do Produto:</th>
                                        <td th:text="${produto.id}"></td>
                                    </tr>
                                    <tr>
                                        <th>Dimens√µes:</th>
                                        <td>
                                            <span th:text="${produto.altura} + ' x ' + ${produto.largura} + ' x ' + ${produto.comprimento}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Volume:</th>
                                        <td th:text="${#numbers.formatDecimal(produto.volume, 1, 2)} + ' m¬≥'"></td>
                                    </tr>
                                    <tr>
                                        <th>Peso:</th>
                                        <td th:text="${#numbers.formatDecimal(produto.peso, 1, 2)} + ' kg'"></td>
                                    </tr>
                                    <tr>
                                        <th>Destino:</th>
                                        <td th:text="${produto.destino}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Sele√ß√£o de Caixa -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-box me-2"></i>Selecionar Caixa
                            </h5>
                            <div class="row" id="caixas-container">
                                <div th:each="caixa : ${caixasDisponiveis}" class="col-md-6 mb-3">
                                    <div class="card h-100 caixa-card"
                                         th:data-caixa-id="${caixa.id}"
                                         th:onclick="|selecionarCaixa(this, ${caixa.id}, ${caixa.volume}, ${caixa.pesoMaximo})|"
                                         style="cursor: pointer;">
                                        <div class="card-body">
                                            <h6 class="card-title">Caixa #<span th:text="${caixa.id}"></span></h6>
                                            <p class="card-text mb-1">
                                                <strong>Dimens√µes:</strong>
                                                <span th:text="${caixa.altura} + 'x' + ${caixa.largura} + 'x' + ${caixa.comprimento} + ' cm'"></span>
                                            </p>
                                            <p class="card-text mb-1">
                                                <strong>Volume:</strong>
                                                <span th:text="${#numbers.formatDecimal(caixa.volume, 1, 2)} + ' cm¬≥'"></span>
                                            </p>
                                            <p class="card-text mb-1">
                                                <strong>Peso M√°x:</strong>
                                                <span th:text="${#numbers.formatDecimal(caixa.pesoMaximo, 1, 2)} + ' kg'"></span>
                                            </p>
                                            <p class="card-text">
                                                <strong>Material:</strong>
                                                <span th:text="${caixa.material}"></span>
                                            </p>

                                            <!-- Indicadores de compatibilidade -->
                                            <div th:if="${produto.volume.doubleValue() <= caixa.volume}"
                                                 class="text-success">
                                                <i class="fas fa-check-circle"></i> Volume compat√≠vel
                                            </div>
                                            <div th:unless="${produto.volume.doubleValue() <= caixa.volume}"
                                                 class="text-danger">
                                                <i class="fas fa-times-circle"></i> Volume incompat√≠vel
                                            </div>

                                            <div th:if="${produto.peso.doubleValue() <= caixa.pesoMaximo}"
                                                 class="text-success">
                                                <i class="fas fa-check-circle"></i> Peso compat√≠vel
                                            </div>
                                            <div th:unless="${produto.peso.doubleValue() <= caixa.pesoMaximo}"
                                                 class="text-danger">
                                                <i class="fas fa-times-circle"></i> Peso incompat√≠vel
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div th:if="${caixasDisponiveis.empty}" class="col-12">
                                    <div class="alert alert-warning text-center">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Nenhuma caixa dispon√≠vel no momento.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- C√°lculo de Dist√¢ncia e Pre√ßo -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-route me-2"></i>C√°lculo de Entrega
                            </h5>
                            <div class="card">
                                <div class="card-body">
                                    <form id="form-encomenda" th:action="@{/encomenda/confirmar}" method="post">
                                        <input type="hidden" name="produtoId" th:value="${produto.id}">
                                        <input type="hidden" id="caixaId" name="caixaId">
                                        <input type="hidden" id="origemHidden" name="origem">
                                        <input type="hidden" id="destinoHidden" name="destino">
                                        <input type="hidden" id="distanciaHidden" name="distancia">
                                        <input type="hidden" id="precoHidden" name="preco">

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="origem" class="form-label">Local de Origem *</label>
                                                <input type="text" class="form-control" id="origem"
                                                       placeholder="Ex: S√£o Paulo, SP" required
                                                       oninput="document.getElementById('origemHidden').value = this.value">
                                                <div class="form-text">Cidade e estado de onde o produto ser√° enviado</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="destino" class="form-label">Destino *</label>
                                                <input type="text" class="form-control" id="destino"
                                                       th:value="${produto.destino}" readonly
                                                       placeholder="Ex: Rio de Janeiro, RJ">
                                                <div class="form-text">Destino definido pelo produto (n√£o edit√°vel)</div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Dist√¢ncia</label>
                                                <div id="distancia" class="form-control-plaintext fw-bold text-primary">
                                                    <span class="text-muted">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Pre√ßo Estimado</label>
                                                <div id="preco" class="form-control-plaintext fw-bold text-success">
                                                    <span class="text-muted">-</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Tempo Estimado</label>
                                                <div id="tempo" class="form-control-plaintext fw-bold text-info">
                                                    <span class="text-muted">-</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="button" id="btn-calcular" class="btn btn-info" disabled>
                                                <i class="fas fa-calculator me-1"></i>Calcular Entrega
                                            </button>
                                            <button type="submit" id="btn-confirmar" class="btn btn-success" disabled>
                                                <i class="fas fa-check me-1"></i>Confirmar Encomenda
                                            </button>
                                            <a th:href="@{/produto}" class="btn btn-secondary">
                                                <i class="fas fa-times me-1"></i>Cancelar
                                            </a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragmentos/footer :: footer}"></footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let caixaSelecionada = null;
    let dadosCalculo = null;

    function selecionarCaixa(element, caixaId, volume, pesoMaximo) {
        // Remove sele√ß√£o anterior
        document.querySelectorAll('.caixa-card').forEach(card => {
            card.classList.remove('border-primary', 'bg-light');
        });

        // Adiciona sele√ß√£o atual
        element.classList.add('border-primary', 'bg-light');
        caixaSelecionada = caixaId;

        // Habilita bot√£o de c√°lculo
        document.getElementById('caixaId').value = caixaId;
        document.getElementById('btn-calcular').disabled = false;
        document.getElementById('btn-confirmar').disabled = true;

        // Resetar dados de c√°lculo
        document.getElementById('distancia').innerHTML = '<span class="text-muted">-</span>';
        document.getElementById('preco').innerHTML = '<span class="text-muted">-</span>';
        document.getElementById('tempo').innerHTML = '<span class="text-muted">-</span>';
        dadosCalculo = null;

        // Verifica compatibilidade
        const produtoVolume = parseFloat([[${produto.volume}]]);
        const produtoPeso = parseFloat([[${produto.peso}]]);

        if (produtoVolume > volume) {
            alert('‚ö†Ô∏è Aten√ß√£o: O volume do produto √© maior que o da caixa selecionada!');
        }
        if (produtoPeso > pesoMaximo) {
            alert('‚ö†Ô∏è Aten√ß√£o: O peso do produto √© maior que o suportado pela caixa!');
        }
    }

    // C√°lculo de dist√¢ncia via API do seu backend
    document.getElementById('btn-calcular').addEventListener('click', async function() {
        const origem = document.getElementById('origem').value;
        const destino = document.getElementById('destino').value;

        if (!origem) {
            alert('Por favor, informe o local de origem.');
            return;
        }

        if (!destino) {
            alert('Por favor, informe o local de destino.');
            return;
        }

        if (!caixaSelecionada) {
            alert('Por favor, selecione uma caixa.');
            return;
        }

        try {
            // Mostrar loading
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Calculando...';
            this.disabled = true;

            // Chamada para SEU backend que j√° integra com a API Distance Matrix
            const response = await fetch('/encomenda/api/calcular-distancia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    origem: origem,
                    destino: destino,
                    produtoId: [[${produto.id}]],
                    caixaId: caixaSelecionada
                })
            });

            const data = await response.json();

            if (data.success) {
                // Atualizar interface com dados reais da API
                document.getElementById('distancia').innerHTML =
                    `<span class="text-primary">${data.distancia} km</span>`;
                document.getElementById('preco').innerHTML =
                    `<span class="text-success">R$ ${parseFloat(data.preco).toFixed(2)}</span>`;
                document.getElementById('tempo').innerHTML =
                    `<span class="text-info">${data.tempo}</span>`;

                // Salvar dados para confirma√ß√£o
                dadosCalculo = {
                    distancia: parseFloat(data.distancia),
                    preco: parseFloat(data.preco),
                    origem: origem,
                    destino: destino
                };

                // Atualizar campos hidden
                document.getElementById('origemHidden').value = dadosCalculo.origem;
                document.getElementById('destinoHidden').value = dadosCalculo.destino;
                document.getElementById('distanciaHidden').value = dadosCalculo.distancia;
                document.getElementById('precoHidden').value = dadosCalculo.preco;

                // Habilitar bot√£o de confirma√ß√£o
                document.getElementById('btn-confirmar').disabled = false;

            } else {
                alert('‚ùå Erro ao calcular: ' + data.message);
            }

        } catch (error) {
            console.error('Erro:', error);
            alert('‚ùå Erro ao calcular dist√¢ncia. Tente novamente.');
        } finally {
            this.innerHTML = '<i class="fas fa-calculator me-1"></i>Calcular Entrega';
            this.disabled = false;
        }
    });

    // Valida√ß√£o antes de enviar o formul√°rio
    document.getElementById('form-encomenda').addEventListener('submit', function(e) {
        if (!caixaSelecionada) {
            e.preventDefault();
            alert('Por favor, selecione uma caixa.');
            return;
        }

        if (!dadosCalculo) {
            e.preventDefault();
            alert('Por favor, calcule a entrega antes de confirmar.');
            return;
        }

        // Garantir que os campos hidden est√£o preenchidos
        document.getElementById('origemHidden').value = document.getElementById('origem').value;
        document.getElementById('destinoHidden').value = document.getElementById('destino').value;

        if (!confirm('üì¶ Confirmar solicita√ß√£o de encomenda?\n\n' +
                    `üìç De: ${document.getElementById('origem').value}\n` +
                    `üìç Para: ${document.getElementById('destino').value}\n` +
                    `üìè Dist√¢ncia: ${dadosCalculo.distancia} km\n` +
                    `üí∞ Pre√ßo: R$ ${dadosCalculo.preco.toFixed(2)}`)) {
            e.preventDefault();
        }
    });
</script>
<style>
    .caixa-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .caixa-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .caixa-card.border-primary {
        border-color: #0d6efd !important;
        background-color: #f8f9fa !important;
    }

    .form-control-plaintext {
        min-height: 38px;
        padding: 6px 12px;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
    }
</style>
</body>
</html>